# **Ethereum dev environment**

## **Install the solc compiler**

**If something goes wrong while you are following the install instructions, please NO INITIATIVE, just report your problem to your instructor**.

As a lot of libraries and tools are configured for using the version `0.6.X` we will install the latest `0.6.X` version: the version `0.6.12`.  
We will install `solc` from the `solc-select` script, a script to quickly switch between Solidity compiler versions:
https://github.com/crytic/solc-select

Please follow the instructions bellow.

### Macosx

Download and install `docker` for mac: https://www.docker.com/get-started

When `docker`is installed, type the following commands in your termnial:

```zsh
% cd ~
% docker pull trailofbits/solc-select
% docker run --read-only -i --rm --entrypoint='/bin/sh' trailofbits/solc-select:latest -c 'cat /usr/bin/install.sh' > a.sh
% sed s+\'/usr/bin/solc\'+\'/usr/local/bin/solc\'+ a.sh > b.sh
% chmod a+x b.sh
% ./b.sh
% chmod a+x /usr/local/bin/solc
% rm a.sh b.sh
```

### Linux

```zsh
% cd ~
% git clone https://github.com/crytic/solc-select.git
% ./solc-select/scripts/install.sh
```

This will install `solc` into `~/.solc-select/`, so you have to add it to the `PATH` variable. Add this line, replacing **USERNAME** with your **username**, to your `~/.zshrc` or equivalent:

```zsh
export PATH=/home/USERNAME/.solc-select:$PATH
```

**The exact line and the file name should be printed at the end of the installation.**

### usage and configuration

When installed we can now check all available `solc` versions:

```zsh
% solc --versions
```

and check the current version actually in use:

```zsh
% solc --version
```

switch to version `0.6.12`:

```zsh
% solc use 0.6.12
```

check if current version is `0.6.12`:

```zsh
% solc --version
solc, the solidity compiler commandline interface
Version: 0.6.12+commit.27d51765.Linux.g++
```

## **Install solc extension for VSCode**

This extension provides syntax highlighting, some error checking and other tools while we are programming in Solidity.

Install the Solidity extension by Juan Blanco:
https://marketplace.visualstudio.com/items?itemName=JuanBlanco.solidity

Set the `solc` version we will use while programming:

```txt
RIGHT CLICK on a `.sol` file -> Solidity: Change global compiler version(remote) -> choose 0.6.12
```

## **Truffle**

`Truffle` is a development environment, testing framework and deployment pipeline for Ethereum smart contracts.  
While we were working on `remix` since the beginning we will now switch to `Truffe` and write our code on `vscode`.

Official documentation: https://www.trufflesuite.com/docs/truffle/overview

### **Install Truffle**

Install truffle globally.

```zsh
% npm install -g truffle
```

Check if everything is installed with:

```zsh
% truffle version
Truffle v5.1.50 (core: 5.1.50)
Solidity v0.5.16 (solc-js)
Node v12.19.0
Web3.js v1.2.9
```

### **Usage**

Create a directory for your project and `cd` inside:

```zsh
% mkdir Calculator
% cd Calculator
```

Initialize a Truffle project, the git repository and a nodejs project:

```zsh
% truffle init
% git init
% yarn init
```

`Truffle` will generate build files while compiling your project in the `build/` directory.  
This directory has to be added into `.gitignore`. (You can use the same .gitignore template generated by `djinit`).

3 directories and 1 config file are generated by the Truffle project initialization:

- `contracts/`: Directory for solidity contracts
- `migrations/`: Directory for scriptable deployment files
- `test/`: Directory for test files for testing the project and the smart contracts.
- `truffle-config.js`: Truffle configuration file

### **Directory `contracts/`**:

This directory will contains all the solidity files of your projects.
Create the files _Adder.sol_, _Suber.sol_, _Multiplier.sol_, _Divisor.sol_ in `contracts/`.

_Adder.sol_:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;
contract Adder {
    function add(uint256 nb1, uint256 nb2) public pure returns (uint256) {
        return nb1 + nb2;
    }
}
```

_Suber.sol_:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;

contract Suber {
    function sub(uint256 nb1, uint256 nb2) public pure returns (uint256) {
        require(nb1 >= nb2, 'Suber: no negative value here.');
        return nb1 - nb2;
  }
}
```

_Multiplier.sol_:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;

contract Multiplier {
    function mul(uint256 nb1, uint256 nb2) public pure returns (uint256) {
        return nb1 * nb2;
    }
}
```

_Divisor.sol_:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;

contract Divisor {
    function div(uint256 nb1, uint256 nb2) public pure returns (uint256) {
        require(nb2 > 0, 'Divisor: can not divide by 0');
        return nb1 / nb2;
    }
}
```

_Calculator.sol_:

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.6.0;
import './Adder.sol';
import './Suber.sol';
import './Multiplier.sol';
import './Divisor.sol';

contract Calculator {
    Adder private adderContract;
    Suber private suberContract;
    Multiplier private multiplierContract;
    Divisor private divisorContract;

    constructor(
        address _adderContract,
        address _suberContract,
        address _multiplierContract,
        address _divisorContract) public
    {
        adderContract = Adder(_adderContract);
        suberContract = Suber(_suberContract);
        multiplierContract = Multiplier(_multiplierContract);
        divisorContract = Divisor(_divisorContract);
    }

    function add(uint256 nb1, uint256 nb2) public view returns (uint256) {
        return adderContract.add(nb1, nb2);
    }

    function sub(uint256 nb1, uint256 nb2) public view returns (uint256) {
        return suberContract.sub(nb1, nb2);
    }

    function mul(uint256 nb1, uint256 nb2) public view returns (uint256) {
        return multiplierContract.mul(nb1, nb2);
    }

    function div(uint256 nb1, uint256 nb2) public view returns (uint256) {
        return divisorContract.div(nb1, nb2);
    }
}
```

There is also a default `Migrations.sol` contract in the directory.  
This contract keeps track of `migrations` AKA deployment, this is a configuration contract.  
**Just keep this file and never touch it.**

### **Directory `migrations/`**:

Official documentation on `migrations`: https://www.trufflesuite.com/docs/truffle/getting-started/running-migrations#migration-files

This directory contains javascript files for managing deployments.  
We call these scripts `migrations`.

To run all migrations, run the following:

```zsh
% truffle migrate --network NETWORK_NAME
```

Networks are configured in `truffle-config.js`.  
If no `--network` option is provided, the default one will be `development`,
so the command:

```zsh
% truffle migrate
```

is an alias for:

```zsh
truffle migrate --network development
```

A `development` network has to be configured in `truffle-config.js`.  
Often the `development` network is the Ethereum blockchain running on a `ganache` node.

Running a migration triggers 2 processes:

1. **compilation**: If a solidity file in `contracts/` is added or is modified then a compilation by the `solc` compiler occurs and an `artifact` for each contract is generated in `./build/contracts`.  
   An `artifact` is a `JSON` file containing ABI, byte-code and various informations about the contract.  
   The compiler version and options is defined in the _truffle-config.js_ config file.
2. **deployment**: The contracts are deployed following the rules described in the javascript files in `migrations/` directory.  
   The available networks for deployment are defined in the _truffle-config.js_ config file.

A default migration script _1_initial_migration.js_ exists in the `migrations/` directory.
**Just keep this file and never touch it.**  
Your `migrations` should start by a number following the previous one, and have a `.js` extension.  
Create migration files `_2_deploy_calc_operations.js_` and `_3_deploy_calculator_contract.js_` in `migrations/` directory for deploying our contracts stored in `contracts/` directory.

_2_deploy_calc_operations.js_:

```js
// Adder is an artifact of the Adder contract
const Adder = artifacts.require('Adder')
// Suber is an artifact of the Suber contract
const Suber = artifacts.require('Suber')
// Multiplier is an artifact of the Multiplier contract
const Multiplier = artifacts.require('Multiplier')
// Divisor is an artifact of the Multiplier contract
const Divisor = artifacts.require('Divisor')

module.exports = async (deployer) => {
  // All the abstractions/instances below are not needed
  // They are only useful if we need to interact with it
  // for further deployments.

  // adderInstance is an abstraction/instance of Adder
  const adderInstance = await deployer.deploy(Adder)
  // suberInstance is an abstraction/instance of Suber
  const suberInstance = await deployer.deploy(Suber)
  // multiplierInstance is an abstraction/instance of Multiplier
  const multiplierInstance = await deployer.deploy(Multiplier)
  //divisorInstance is an abstraction/instance of Divisor
  const divisorInstance = await deployer.deploy(Divisor)
}
```

_3_deploy_calculator_contract.js_:

```js
// Adder is an artifact of the Adder contract
const Adder = artifacts.require('Adder')
// Suber is an artifact of the Suber contract
const Suber = artifacts.require('Suber')
// Multiplier is an artifact of the Multiplier contract
const Multiplier = artifacts.require('Multiplier')
// Divisor is an artifact of the Multiplier contract
const Divisor = artifacts.require('Divisor')
// Calculator is an artifact of the Calculator contract
const Calculator = artifacts.require('Calculator')

module.exports = async (deployer) => {
  // multiplierInstance is an instance of the already deployed Multiplier contract
  const multiplierInstance = await Multiplier.deployed()
  // divisorInstance is an instance of the already deployed Divisor contract
  const divisorInstance = await Divisor.deployed()
  const calculatorInstance = await deployer.deploy(
    Calculator,
    Adder.address, // use Adder address from artifact
    Suber.address, // use Suber address from artifact
    multiplierInstance.address, // use Multiplier address from instance
    divisorInstance.address // use Divisor address from instance
  )
}
```

### **Configuration of `truffle-config.js`**

Official documentation on `truffle-config.js`: https://www.trufflesuite.com/docs/truffle/reference/configuration  
This file is a Javascript file and can execute any code necessary to create your configuration. It must export an object representing your project configuration like the example below:

```js
module.exports = {
  // Configure networks
  networks: {
    development: {
      host: '127.0.0.1',
      port: 8545,
      network_id: '*', // Match any network id
    },
  },
  // Configure MochaJS testing framework
  mocha: {
    // timeout: 100000
  },
  // Configure your compilers
  compilers: {
    solc: {
      version: 'native',
    },
  },
}
```

### **Directory `test/`**:

We will use the OpenZepplin test helpers and test environment.
Install these packages as dev dependencies:

```zsh
yarn add --dev @openzeppelin/test-helpers @openzeppelin/test-environment mocha chai
```

We will no use `truffle test` for running tests since we switched to OpenZepplin test env.
So make Mocha the entry point of the test suite by modifying your _package.json_:  
add to _package.json_:

```json
"scripts": {
    "test": "npx mocha --exit --recursive"
},
```

we can now run test with `yarn test` command.`yarn test` will not compile your smart contracts. You will have to compile your smart contracts with`truffle compile` first.

Add _operations.test.js_ in your `test/` directory:
_operations.test.js_:

```js
const { contract } = require('@openzeppelin/test-environment')

const { BN, expectRevert } = require('@openzeppelin/test-helpers')
const { expect } = require('chai')

const Adder = contract.fromArtifact('Adder')
const Suber = contract.fromArtifact('Suber')

describe('Adder', () => {
  beforeEach(async function () {
    this.adder = await Adder.new()
  })

  it('add numbers', async function () {
    expect(await this.adder.add(1, 1)).to.be.bignumber.equal(new BN(2))
  })
})

describe('Suber', () => {
  beforeEach(async function () {
    this.suber = await Suber.new()
  })

  it('substract numbers nb1 - nb2', async function () {
    expect(await this.suber.sub(100, 98)).to.be.bignumber.equal(new BN(2))
  })

  it('reverts when nb1 < nb2', async function () {
    await expectRevert(
      this.suber.sub(98, 199),
      'Suber: no negative value here.'
    )
  })
})
```

Compile your smart contracts: `truffle compile`.  
we can now run our test with:

```zsh
% yarn test
yarn run v1.22.10
$ npx mocha --exit --recursive

  Adder
    ✓ add numbers (38ms)

  Suber
    ✓ substract numbers nb1 - nb2
    ✓ reverts when nb1 < nb2 (49ms)


  3 passing (577ms)

✨  Done in 1.73s.
```

## **Infura**

Official website: https://infura.io/

`Infura` API provides access over `HTTPS` and `WebSockets` to the Ethereum and IPFS networks for our applications.  
Without `Infura` we would need to connect directly to an Ethereum node and use the default `JSON RPC` default API.  
So with `Infura` API we can connect our Frontend, backend and Truffle to the Ethereum network with `HTTPS`.  
For deploying on mainnet and testnets Truffle migration scripts need access to the Ethereum network, `Infura` is an easy way to provide this access over HTTPS/WS.

Register on `Infura` and create an Ethereum project.
When a project is created, in the `SETTINGS` you have access to:

- Project ID: Identifier of your project.
- Project Secret: The api key of your project, keep it secret.
- Endpoints: HTTPS/WS link to access the `Infura` API for your project.

## **Linters and code formatters**

You may need to restart your VSCode for applying linters and code formatters.  
[solidity](https://marketplace.visualstudio.com/items?itemName=JuanBlanco.solidity), [eslint](https://marketplace.visualstudio.com/items?itemname=dbaeumer.vscode-eslint) and [prettier](https://marketplace.visualstudio.com/items?itemName=esbenp.prettier-vscode) extensions for VSCode are needed before installing the tools below.

### **solhint**

`solhint`: https://protofire.github.io/solhint/  
`solhint` is a linter and perform static analysis of solidity files for finding errors and bad code practice.  
Inside your project directory:  
install `solhint` as dev dependency:

```zsh
yarn add --dev solhint
```

and create a _.solhint.json_ config file:

```json
{
  "extends": "solhint:recommended",
  "rules": {
    "func-order": "off",
    "mark-callable-contracts": "off",
    "no-empty-blocks": "off",
    "compiler-version": ["error", "^0.6.0"],
    "private-vars-leading-underscore": "error",
    "reason-string": "off"
  }
}
```

### **eslint**

`eslint`: https://eslint.org/docs/user-guide/getting-started  
As our migration and test files are written in JavaScript, we also need a linter for JS files.  
`eslint` is a linter and perform static analysis of solidity files for finding errors and bad code practice.  
Inside your project directory:  
install `eslint` and its plugins as dev dependency:

```zsh
yarn add --dev eslint eslint-config-standard eslint-plugin-import eslint-plugin-mocha-no-only eslint-plugin-node eslint-plugin-promise eslint-plugin-standard
```

and create a _.eslintrc_ config file:

```js
{
  "extends": ["standard", "plugin:promise/recommended"],
  "plugins": ["mocha-no-only", "promise"],
  "env": {
    "browser": true,
    "node": true,
    "mocha": true,
    "jest": true
  },
  "globals": {
    "artifacts": false,
    "contract": false,
    "assert": false,
    "web3": false
  },
  "rules": {
    // Strict mode
    "strict": ["error", "global"],

    // Code style
    "array-bracket-spacing": ["off"],
    "camelcase": ["error", { "properties": "always" }],
    "comma-dangle": ["error", "always-multiline"],
    "comma-spacing": ["error", { "before": false, "after": true }],
    "dot-notation": ["error", { "allowKeywords": true, "allowPattern": "" }],
    "eol-last": ["error", "always"],
    "eqeqeq": ["error", "smart"],
    "generator-star-spacing": ["error", "before"],
    "indent": ["error", 2],
    "linebreak-style": ["error", "unix"],
    "max-len": ["error", 120, 2],
    "no-debugger": "off",
    "no-dupe-args": "error",
    "no-dupe-keys": "error",
    "no-mixed-spaces-and-tabs": ["error", "smart-tabs"],
    "no-redeclare": ["error", { "builtinGlobals": true }],
    "no-trailing-spaces": ["error", { "skipBlankLines": false }],
    "no-undef": "error",
    "no-use-before-define": "off",
    "no-var": "error",
    "object-curly-spacing": ["error", "always"],
    "prefer-const": "error",
    "quotes": ["error", "single"],
    "semi": ["error", "always"],
    "space-before-function-paren": ["error", "always"],

    "mocha-no-only/mocha-no-only": ["error"],

    "promise/always-return": "off",
    "promise/avoid-new": "off"
  },
  "parserOptions": {
    "ecmaVersion": 2018
  }
}
```

### **prettier**

`prettier`is a code formatter. It formats our code automatically on save.  
In your project directory install `prettier` and `prettier-plugin-solidity` as dev dependency:

```zsh
yarn add --dev prettier prettier-plugin-solidity
```

and create a _.prettierrc_ config file:

```js
{
  "overrides": [
    {
      "files": "*.sol",
      "options": {
        "printWidth": 120,
        "tabWidth": 4,
        "useTabs": false,
        "singleQuote": false,
        "bracketSpacing": false,
        "explicitTypes": "always"
      }
    },
    {
      "files": "*.js",
      "options": {
        "printWidth": 120,
        "tabWidth": 2,
        "useTabs": false,
        "semi": true,
        "singleQuote": true,
        "arrowParens": "always",
        "bracketSpacing": true,
        "trailingComma": "all"

      }
    }
  ]
}
```

At this point code formatting can be broken.  
First try to restart your VSCode.
If code formatting still doesn't work right click on an opened solidity file in the editor, select `Format Document` and select `prettier` as default formatter.
Do the same with a JavaScript file.
Now code formatting of JS and solidity file should work.

### EditorConfig

Install the EditorConfig extension: https://marketplace.visualstudio.com/items?itemName=EditorConfig.EditorConfig

In your project create a `.editorconfig` file:

```js
# EditorConfig is awesome: https://EditorConfig.org

# top-most EditorConfig file
root = true

[*]
charset = utf-8
end_of_line = lf
indent_style = space
insert_final_newline = true
trim_trailing_whitespace = false
max_line_length = 120

[*.sol]
indent_size = 4

[*.js]
indent_size = 2

[*.adoc]
max_line_length = 0

```
